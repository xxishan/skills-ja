---
name: mcp-builder
description: LLMが適切に設計されたツールを通じて外部サービスと対話できるようにする高品質なMCP（Model Context Protocol）サーバーを作成するためのガイド。Python（FastMCP）またはNode/TypeScript（MCP SDK）で外部APIやサービスを統合するMCPサーバーを構築する際に使用します。
license: 完全な条項はLICENSE.txtを参照
---

# MCP サーバー開発ガイド

## 概要

LLM が外部サービスと効果的に対話できるようにする高品質な MCP（Model Context Protocol）サーバーを作成するには、このスキルを使用します。MCP サーバーは、LLM が外部サービスや API にアクセスできるようにするツールを提供します。MCP サーバーの品質は、提供されるツールを使用して LLM が実世界のタスクをどれだけ効果的に達成できるかによって測定されます。

---

# プロセス

## 🚀 高レベルワークフロー

高品質な MCP サーバーの作成には、4 つの主要なフェーズがあります:

### フェーズ 1: 徹底的なリサーチと計画

#### 1.1 エージェント中心の設計原則を理解する

実装に入る前に、これらの原則を確認して AI エージェント向けのツール設計方法を理解します:

**ワークフロー向けに構築し、単なる API エンドポイントではない:**

- 既存の API エンドポイントを単純にラップするのではなく、思慮深く影響力の高いワークフローツールを構築する
- 関連する操作を統合する（例: 可用性をチェックしてイベントを作成する`schedule_event`）
- 個別の API 呼び出しではなく、完全なタスクを可能にするツールに焦点を当てる
- エージェントが実際に達成する必要があるワークフローを考慮する

**限られたコンテキストに最適化:**

- エージェントは制約されたコンテキストウィンドウを持つ - すべてのトークンを有効に活用する
- 包括的なデータダンプではなく、シグナルの高い情報を返す
- 「簡潔」vs「詳細」な応答フォーマットオプションを提供する
- 技術的なコードよりも人間が読める ID を優先する（ID よりも名前）
- エージェントのコンテキスト予算を希少なリソースとして考慮する

**実行可能なエラーメッセージを設計:**

- エラーメッセージはエージェントを正しい使用パターンへと導くべき
- 具体的な次のステップを提案する: "結果を減らすには filter='active_only' を試してください"
- 診断的なだけでなく、教育的なエラーにする
- 明確なフィードバックを通じてエージェントが適切なツール使用を学べるようにする

**自然なタスク分割に従う:**

- ツール名は人間がタスクについて考える方法を反映すべき
- 発見しやすいように一貫したプレフィックスで関連ツールをグループ化する
- API 構造だけでなく、自然なワークフローに基づいてツールを設計する

**評価駆動型開発を使用:**

- 早期に現実的な評価シナリオを作成する
- エージェントのフィードバックでツールの改善を推進する
- 実際のエージェントのパフォーマンスに基づいて迅速にプロトタイプを作成し、反復する

#### 1.3 MCP プロトコルドキュメントを学習する

**最新の MCP プロトコルドキュメントを取得:**

WebFetch を使用してロード: `https://modelcontextprotocol.io/llms-full.txt`

この包括的なドキュメントには、完全な MCP 仕様とガイドラインが含まれています。

#### 1.4 フレームワークドキュメントを学習する

**以下の参照ファイルをロードして読む:**

- **MCP ベストプラクティス**: [📋 ベストプラクティスを見る](./reference/mcp_best_practices.md) - すべての MCP サーバーのコアガイドライン

**Python 実装の場合、以下もロード:**

- **Python SDK ドキュメント**: WebFetch を使用して`https://raw.githubusercontent.com/modelcontextprotocol/python-sdk/main/README.md`をロード
- [🐍 Python 実装ガイド](./reference/python_mcp_server.md) - Python 固有のベストプラクティスと例

**Node/TypeScript 実装の場合、以下もロード:**

- **TypeScript SDK ドキュメント**: WebFetch を使用して`https://raw.githubusercontent.com/modelcontextprotocol/typescript-sdk/main/README.md`をロード
- [⚡ TypeScript 実装ガイド](./reference/node_mcp_server.md) - Node/TypeScript 固有のベストプラクティスと例

#### 1.5 API ドキュメントを徹底的に学習する

サービスを統合するには、**すべての**利用可能な API ドキュメントを読み通します:

- 公式 API リファレンスドキュメント
- 認証と認可の要件
- レート制限とページネーションパターン
- エラーレスポンスとステータスコード
- 利用可能なエンドポイントとそのパラメータ
- データモデルとスキーマ

**包括的な情報を収集するには、必要に応じて Web 検索と WebFetch ツールを使用します。**

#### 1.6 包括的な実装計画を作成する

リサーチに基づいて、以下を含む詳細な計画を作成します:

**ツールの選択:**

- 実装する最も価値のあるエンドポイント/操作をリストアップする
- 最も一般的で重要なユースケースを可能にするツールを優先する
- 複雑なワークフローを可能にするために連携するツールを考慮する

**共有ユーティリティとヘルパー:**

- 共通の API リクエストパターンを識別する
- ページネーションヘルパーを計画する
- フィルタリングとフォーマットユーティリティを設計する
- エラーハンドリング戦略を計画する

**入出力設計:**

- 入力検証モデルを定義する（Python は Pydantic、TypeScript は Zod）
- 一貫した応答フォーマットを設計する（例: JSON または Markdown）、および設定可能な詳細レベル（例: 詳細または簡潔）
- 大規模使用（数千のユーザー/リソース）を計画する
- 文字制限と切り捨て戦略を実装する（例: 25,000 トークン）

**エラーハンドリング戦略:**

- グレースフルな失敗モードを計画する
- 明確で実行可能な、LLM フレンドリーで、さらなるアクションを促す自然言語のエラーメッセージを設計する
- レート制限とタイムアウトシナリオを考慮する
- 認証と認可のエラーを処理する

---

### フェーズ 2: 実装

包括的な計画ができたので、言語固有のベストプラクティスに従って実装を開始します。

#### 2.1 プロジェクト構造をセットアップする

**Python の場合:**

- 単一の`.py`ファイルを作成するか、複雑な場合はモジュールに整理する（[🐍 Python ガイド](./reference/python_mcp_server.md)参照）
- MCP Python SDK をツール登録に使用する
- 入力検証用に Pydantic モデルを定義する

**Node/TypeScript の場合:**

- 適切なプロジェクト構造を作成する（[⚡ TypeScript ガイド](./reference/node_mcp_server.md)参照）
- `package.json`と`tsconfig.json`をセットアップする
- MCP TypeScript SDK を使用する
- 入力検証用に Zod スキーマを定義する

#### 2.2 まずコアインフラストラクチャを実装する

**実装を開始するには、ツールを実装する前に共有ユーティリティを作成します:**

- API リクエストヘルパー関数
- エラーハンドリングユーティリティ
- 応答フォーマット関数（JSON と Markdown）
- ページネーションヘルパー
- 認証/トークン管理

#### 2.3 ツールを体系的に実装する

計画内の各ツールに対して:

**入力スキーマを定義:**

- 検証に Pydantic（Python）または Zod（TypeScript）を使用する
- 適切な制約を含める（最小/最大長、正規表現パターン、最小/最大値、範囲）
- 明確で説明的なフィールドの説明を提供する
- フィールドの説明に多様な例を含める

**包括的な docstring/説明を書く:**

- ツールが何をするかの 1 行の要約
- 目的と機能の詳細な説明
- 例付きの明示的なパラメータタイプ
- 完全な戻り値タイプスキーマ
- 使用例（いつ使用するか、いつ使用しないか）
- エラーハンドリングドキュメント - 特定のエラーが発生した場合の対処方法を概説

**ツールロジックを実装:**

- コードの重複を避けるために共有ユーティリティを使用する
- すべての I/O に async/await パターンに従う
- 適切なエラーハンドリングを実装する
- 複数の応答フォーマット（JSON と Markdown）をサポートする
- ページネーションパラメータを尊重する
- 文字制限をチェックし、適切に切り捨てる

**ツールアノテーションを追加:**

- `readOnlyHint`: true（読み取り専用操作の場合）
- `destructiveHint`: false（非破壊的操作の場合）
- `idempotentHint`: true（繰り返し呼び出しが同じ効果を持つ場合）
- `openWorldHint`: true（外部システムと対話する場合）

#### 2.4 言語固有のベストプラクティスに従う

**この時点で、適切な言語ガイドをロードします:**

**Python の場合: [🐍 Python 実装ガイド](./reference/python_mcp_server.md)をロードし、以下を確認:**

- 適切なツール登録で MCP Python SDK を使用
- `model_config`を持つ Pydantic v2 モデル
- 全体にわたるタイプヒント
- すべての I/O 操作に async/await
- 適切なインポートの整理
- モジュールレベルの定数（CHARACTER_LIMIT、API_BASE_URL）

**Node/TypeScript の場合: [⚡ TypeScript 実装ガイド](./reference/node_mcp_server.md)をロードし、以下を確認:**

- `server.registerTool`を適切に使用
- `.strict()`を持つ Zod スキーマ
- TypeScript ストリクトモードを有効化
- `any`タイプを使用しない - 適切な型を使用
- 明示的な Promise<T>戻り値タイプ
- ビルドプロセスを設定（`npm run build`）

---

### フェーズ 3: レビューと改善

初期実装の後:

#### 3.1 コード品質レビュー

品質を確保するため、コードを以下の点でレビューします:

- **DRY 原則**: ツール間でコードの重複がない
- **構成可能性**: 共有ロジックが関数に抽出されている
- **一貫性**: 類似の操作が類似のフォーマットを返す
- **エラーハンドリング**: すべての外部呼び出しにエラーハンドリングがある
- **型安全性**: 完全な型カバレッジ（Python タイプヒント、TypeScript 型）
- **ドキュメント**: すべてのツールに包括的な docstring/説明がある

#### 3.2 テストとビルド

**重要:** MCP サーバーは、stdio/stdin または sse/http 経由でリクエストを待つ長時間実行プロセスです。メインプロセスで直接実行する（例: `python server.py`や`node dist/index.js`）と、プロセスが無期限にハングします。

**サーバーをテストする安全な方法:**

- 評価ハーネスを使用する（フェーズ 4 参照） - 推奨アプローチ
- メインプロセスの外側に保つために tmux でサーバーを実行する
- テスト時にタイムアウトを使用する: `timeout 5s python server.py`

**Python の場合:**

- Python 構文を検証: `python -m py_compile your_server.py`
- ファイルを確認してインポートが正しく動作することをチェック
- 手動テストする場合: tmux でサーバーを実行し、メインプロセスで評価ハーネスでテスト
- または評価ハーネスを直接使用（stdio 転送用にサーバーを管理します）

**Node/TypeScript の場合:**

- `npm run build`を実行し、エラーなく完了することを確認
- dist/index.js が作成されたことを確認
- 手動テストする場合: tmux でサーバーを実行し、メインプロセスで評価ハーネスでテスト
- または評価ハーネスを直接使用（stdio 転送用にサーバーを管理します）

#### 3.3 品質チェックリストを使用

実装品質を検証するには、言語固有のガイドから適切なチェックリストをロードします:

- Python: [🐍 Python ガイド](./reference/python_mcp_server.md)の「品質チェックリスト」を参照
- Node/TypeScript: [⚡ TypeScript ガイド](./reference/node_mcp_server.md)の「品質チェックリスト」を参照

---

### フェーズ 4: 評価を作成

MCP サーバーを実装した後、その効果をテストするための包括的な評価を作成します。

**完全な評価ガイドラインについては[✅ 評価ガイド](./reference/evaluation.md)をロードします。**

#### 4.1 評価の目的を理解する

評価は、LLM が MCP サーバーを使用して現実的で複雑な質問に効果的に答えられるかをテストします。

#### 4.2 10 個の評価質問を作成する

効果的な評価を作成するには、評価ガイドに記載されているプロセスに従います:

1. **ツール検査**: 利用可能なツールをリストアップし、その機能を理解する
2. **コンテンツ探索**: 読み取り専用操作を使用して利用可能なデータを探索する
3. **質問生成**: 10 個の複雑で現実的な質問を作成する
4. **回答検証**: 各質問を自分で解いて回答を検証する

#### 4.3 評価要件

各質問は以下である必要があります:

- **独立している**: 他の質問に依存しない
- **読み取り専用**: 非破壊的な操作のみが必要
- **複雑**: 複数のツール呼び出しと深い探索が必要
- **現実的**: 人間が気にする実際のユースケースに基づいている
- **検証可能**: 文字列比較で検証できる単一の明確な回答
- **安定**: 回答が時間とともに変化しない

#### 4.4 出力フォーマット

以下の構造で XML ファイルを作成します:

```xml
<evaluation>
  <qa_pair>
    <question>動物のコードネームを持つAIモデルのローンチに関する議論を見つけてください。あるモデルは、ASL-Xという形式を使用する特定の安全性指定が必要でした。斑点のある野生の猫にちなんで名付けられたモデルに対して決定されていたXの数字は何でしたか？</question>
    <answer>3</answer>
  </qa_pair>
<!-- さらなるqa_pairs... -->
</evaluation>
```

---

# 参照ファイル

## 📚 ドキュメントライブラリ

開発中に必要に応じてこれらのリソースをロードします:

### コア MCP ドキュメント（最初にロード）

- **MCP プロトコル**: `https://modelcontextprotocol.io/llms-full.txt`から取得 - 完全な MCP 仕様
- [📋 MCP ベストプラクティス](./reference/mcp_best_practices.md) - 以下を含む普遍的な MCP ガイドライン:
  - サーバーとツールの命名規則
  - 応答フォーマットガイドライン（JSON vs Markdown）
  - ページネーションベストプラクティス
  - 文字制限と切り捨て戦略
  - ツール開発ガイドライン
  - セキュリティとエラーハンドリング標準

### SDK ドキュメント（フェーズ 1/2 中にロード）

- **Python SDK**: `https://raw.githubusercontent.com/modelcontextprotocol/python-sdk/main/README.md`から取得
- **TypeScript SDK**: `https://raw.githubusercontent.com/modelcontextprotocol/typescript-sdk/main/README.md`から取得

### 言語固有の実装ガイド（フェーズ 2 中にロード）

- [🐍 Python 実装ガイド](./reference/python_mcp_server.md) - 以下を含む完全な Python/FastMCP ガイド:

  - サーバー初期化パターン
  - Pydantic モデルの例
  - `@mcp.tool`でのツール登録
  - 完全な動作例
  - 品質チェックリスト

- [⚡ TypeScript 実装ガイド](./reference/node_mcp_server.md) - 以下を含む完全な TypeScript ガイド:
  - プロジェクト構造
  - Zod スキーマパターン
  - `server.registerTool`でのツール登録
  - 完全な動作例
  - 品質チェックリスト

### 評価ガイド（フェーズ 4 中にロード）

- [✅ 評価ガイド](./reference/evaluation.md) - 以下を含む完全な評価作成ガイド:
  - 質問作成ガイドライン
  - 回答検証戦略
  - XML フォーマット仕様
  - 質問と回答の例
  - 提供されたスクリプトで評価を実行する
